# Components

## The Renderer component

The Renderer component is used to render any content from BackBee core.
It provides a ``Renderer`` object able to:

* Search for templates according to available adapters;
* Render BackBee ``Page`` but also any ``ClassContent``;
* Accept multiple rendering modes for each content to be rendered;
* Can Render only an HTML fragment;
* Manage Web assets (CSS and Javascripts).

## The Big picture

Let's start with a schema that represents the BackBee architecture on a simple page:

![the BackBee big picture](http://i.imgur.com/sLLJ19x.png "the BackBee big picture")

Each element have has an objective representation inside **BackBee core library**:

 - **Site** (``BackBuilder\Site\Site``) is your application.
 - **Page** (``BackBuilder\NestedNode\Page``) represent each page of your application, for example BackBee CMS provide three pages: home page, article page and category page.
 - **Layout** (``BackBuilder\Site\Layout``) represent the layout of a page.
 - **ContentSet** (``BackBuilder\ClassContent\ContentSet``) represent the blocks/columns of layouts, which can be edited by user.

When an user accesses to a page, the ``Renderer::render()`` method is called.

> During the rendereing process, three events are dispatched: ``prerender``, ``render`` and ``postrender``.

## Renderer adapters and manageable extensions

The BackBee Renderer Component is able to render different templating engines thanks to Adapters.
In BackBee Standard Edition, two adapters are provided:
* The ``PHTML`` Adapter
* The ``Twig`` Adapter

When BackBee tries to render content, it looks for a template and then it looks for the file extension.
If the extension file is part of the manageable extensions and if an Adapter is found for this extension, the Adapter is called to render the template with the assigned variables.

To implement your own adapter, for [Smarty](http://www.smarty.net/) you need to implement the ``BackBee\Renderer\RendererAdapterInterface`` interface.

```php
<?php

/*
 * Copyright (c) 2011-2015 Lp digital system
 *
 * This file is part of BackBee.
 *
 * BackBee is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * BackBee is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with BackBee. If not, see <http://www.gnu.org/licenses/>.
 *
 * @author Charles Rouillon <charles.rouillon@lp-digital.fr>
 */

namespace BackBee\Renderer;

use BackBee\Site\Layout;

/**
 * Interface for a renderer adapter.
 *
 * @category    BackBee
 *
 * @copyright   Lp digital system
 * @author      e.chau <eric.chau@lp-digital.fr>
 */
interface RendererAdapterInterface
{
    /**
     * Constructor; every RendererAdapter need to be construct with a AbstractRenderer
     *
     * @param AbstractRenderer $renderer
     */
    public function __construct(AbstractRenderer $renderer, array $config = []);

    /**
     * Returns array that contains every single file's extension managed by this adapter.
     *
     * @return array
     */
    public function getManagedFileExtensions();

    /**
     * Check if $filename exist in $templateDir; it also checks if the file is readable.
     *
     * @param string $filename
     * @param array  $templateDir array that contains every directories where it has to looking
     *                            for $filename
     *
     * @return boolean true if the filename was found into $templateDir and it's readable,
     *                 else it returns false
     */
    public function isValidTemplateFile($filename, array $templateDir);

    /**
     * Returns render of $filename template which is compute with $params and $vars.
     *
     * @param string $filename
     * @param array  $templateDir
     * @param array  $params
     *
     * @return string
     */
    public function renderTemplate($filename, array $templateDir, array $params = array(), array $vars = array());

    /**
     * Updates a file script of a layout.
     *
     * @param Layout $layout     The layout to update
     * @param string $layoutFile the layout with absolute path generated by ARendrer::updateLayout()
     *
     * @return string The filename of the updated script
     */
    public function updateLayout(Layout $layout, $layoutFile);

    /**
     * This is called everytime we clone a renderer.
     *
     * @param Renderer $renderer the new renderer
     */
    public function onNewRenderer(AbstractRenderer $renderer);

    /**
     * This is called everytime we restore previous renderer.
     *
     * @param Renderer $renderer the previous renderer
     */
    public function onRestorePreviousRenderer(AbstractRenderer $renderer);
}

```

An adapter can also extend ``BackBee\Renderer\AbstractRendererAdapter`` to help you focus only on templating engine specificities you want to support.


## Render a Page / ClassContent

Rendering a Page or a ClassContent starts in the ``Renderer::render()`` method:

```
<?php
// in the BackBee Renderer class
public function render(
    RenderableInterface $obj = null,
    $mode = null,
    $params = null,
    $template = null,
    $ignoreModeIfNotSet = false
    ){ /* rendering is done here */ }
}
```

If the object is an instance of ``BackBee\Site\Page``, the function ``renderPage`` is called inside ``render()`` function.

* This method loads the Page Layout object and then loops into all the ContentSet objects, and for each ContentSet loop into all the ClassContents and try to render them.

* Finaly, it uses the template related to the layout through the method ``renderTemplate`` which calls the selected ``Adapter::renderTemplate()`` function.

Else, if the object is not a Page instance, the function ``renderContent()`` is directly called.

*If the object is nil or doesn't implement ``RenderableInterface`` interface, the Renderer doesn't return an exception but nothing.*


## Partial rendering

BackBee Renderer component can render partial HTML fragments. Under the hood, this is the ``renderPartial()`` method which is used to render the HTML fragment.

```php
// in the BackBee Renderer class

public function partial($template = null, $params = null)
{
    // return a partial content
}
```

To call a partial in your template, the file need to be in ``repository/Templates/scripts/partials`` folder:

```twig
<!DOCTYPE html>
<html lang="fr">

    {{ this.partial('partials/header-head.twig')|raw }}

    <body>
    <!-- ... -->
    </body>
</html>
```

> If you use a partial, you can use the helpers to inject the styles and the javascripts because they are not called inside the partials.

## Asset management

In addition, the BackBee Renderer Component provides nice helpers to help you add assets dynamicaly.

BackBee helps you add any resource available in your application, here is a list of available helpers:

* ``getImageUrl``, ``getMediaUrl`` and ``getResourceUrl`` : get any file from any **Resource** folder (both in application and bundles);
* ``getUri`` : get any file from the ``public`` folder of an BackBee application;
* ``addStylesheet``, ``addHeaderJs`` and ``addFooterJs`` allowing you to generate the correct CSS or Javascript call. For the Javascript files you can choose to import Javascript in the ``<header>`` or in the bottom of the ``<body>``;
* ``getUrlByRouteName`` is another helper to manage urls of an application.

## Global variables

The BackBee Renderer Component embeds some useful variables in each template from the BackBee application.

```php
<?php
// in the BackBee Renderer class
/**
     * Returns default parameters that are availables in every templates.
     *
     * @return array
     */
    private function getBBVariable()
    {
        return [
            'bb' => [
                'debug'      => $this->getApplication()->isDebugMode(),
                'token'      => $this->getApplication()->getBBUserToken(),
                'request'    => $this->getApplication()->getRequest(),
                'routing'    => $this->getApplication()->getRouting(),
                'translator' => $this->getApplication()->getContainer()->get('translator'),
            ],
        ];
    }
```

This way, in template you can do:

```html
<!DOCTYPE html>
<html>
<head>
</head>
    <body>
        <?php if($this->token !== null) ?>
        Hi <?php echo $this->token->getUser()->getUsername(); ?>
        <?php else : ?>
        You are non authenticated.
        <?php endif; ?>
    </body>
</html>
```

In BackBee Standard application you also have access to specific helpers:

* ``bbtoolbar()`` : display the toolbar application. *You need to have an element with the CSS identifier **bb5-site-wrapper** or else the application has bad design behaviors*.
* ``navbar()`` : display a menu for all pages which has the "display in the menus" option activated.
* ``container()`` allows you to loop into the contentset of your layout and then, design your page.

As a complete example, you can take a look at the *Article* layout:

```twig
<!DOCTYPE html>
<html lang="fr">
    {{ this.partial('partials/header-head.twig')|raw }}
    <body>
        {{ this.bbtoolbar()|raw }} {# When logged, display the toolbar #}
        <div id="bb5-site-wrapper">
            {{ this.navbar()|raw }} {# display the menu #}
            <!-- Some content -->
            <div class="row relative" id="bb5-mainLayoutRow">
                <div class="col-sm-12 col-md-10">
                    {{ this.container().first()|raw }}
                </div>
                <div class="col-md-2 visible-md" id="sidebar" data-scroller="true">
                    {{ this.container().next()|raw }}
                </div>
            </div>
        </div><!-- End BackBee Site wrapper -->
    </body>
</html>
```
